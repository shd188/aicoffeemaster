<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咖啡AI助手 - 模型微调方案</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #6f4e37;
            border-bottom: 2px solid #e6ded3;
            padding-bottom: 10px;
        }
        h2 {
            color: #6f4e37;
            margin-top: 30px;
        }
        h3 {
            color: #917c6f;
        }
        .warning {
            background-color: #fff8dc;
            padding: 15px;
            border-left: 4px solid #e6b422;
            margin: 15px 0;
        }
        .tip {
            background-color: #e6ded3;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .code-block {
            background-color: #f8f5f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: monospace;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #d9cfc1;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #e6ded3;
        }
    </style>
</head>
<body>
    <h1>咖啡AI助手 - 模型微调方案</h1>
    
    <h2>1. 微调基础</h2>
    
    <h3>1.1 基础模型选择</h3>
    <p>选择Deepseek作为基础模型，考虑因素：</p>
    <ul>
        <li>在中文内容理解方面表现出色</li>
        <li>适合领域特化微调</li>
        <li>模型参数量适中，微调成本合理</li>
        <li>推理速度满足实时交互需求</li>
    </ul>
    
    <h3>1.2 微调目标</h3>
    <ul>
        <li>增强咖啡专业知识准确性</li>
        <li>提升咖啡专业术语理解能力</li>
        <li>优化参数计算和推荐能力</li>
        <li>改进咖啡问题诊断与解决方案生成</li>
        <li>增强风味描述与分析能力</li>
    </ul>
    
    <div class="tip">
        <strong>提示：</strong> 为保持模型通用能力，采用轻量级微调方法，避免过度专业化导致在非咖啡领域能力下降。
    </div>
    
    <h2>2. 数据集构建</h2>
    
    <h3>2.1 数据来源</h3>
    <table>
        <tr>
            <th>数据类型</th>
            <th>来源</th>
            <th>数量</th>
            <th>用途</th>
        </tr>
        <tr>
            <td>专家问答对</td>
            <td>咖啡师访谈、专业论坛</td>
            <td>5000对</td>
            <td>基础知识问答</td>
        </tr>
        <tr>
            <td>杯测笔记</td>
            <td>专业杯测师评价、比赛记录</td>
            <td>3000条</td>
            <td>风味描述能力</td>
        </tr>
        <tr>
            <td>故障诊断案例</td>
            <td>咖啡设备维修记录、用户反馈</td>
            <td>2000条</td>
            <td>问题诊断能力</td>
        </tr>
        <tr>
            <td>萃取参数记录</td>
            <td>专业咖啡师配方、实验数据</td>
            <td>1500条</td>
            <td>参数计算能力</td>
        </tr>
        <tr>
            <td>咖啡百科内容</td>
            <td>专业教材、SCA资料</td>
            <td>10000段</td>
            <td>领域知识增强</td>
        </tr>
    </table>
    
    <h3>2.2 数据处理流程</h3>
    <ol>
        <li>数据收集：多渠道获取原始咖啡领域文本</li>
        <li>数据清洗：去除低质量、重复内容</li>
        <li>术语标准化：统一咖啡专业术语表达</li>
        <li>数据增强：生成多样化的问题表达</li>
        <li>数据标注：专家审核内容准确性</li>
        <li>格式转换：转为模型训练所需格式</li>
    </ol>
    
    <h3>2.3 指令微调数据示例</h3>
    <div class="code-block">
[
  {
    "instruction": "解释意式咖啡萃取中的'压力分布'概念及其对风味的影响",
    "input": "",
    "output": "压力分布是意式咖啡萃取中的关键概念，指咖啡粉饼在萃取过程中承受的9 bar压力如何均匀地作用于整个咖啡粉饼表面。\n\n理想的压力分布应当均匀，这需要：\n1. 咖啡粉的均匀分布：使用分布器(distribution tool)确保咖啡粉在滤篮中均匀分布\n2. 适当的填压力度：通常为15-20kg，保持水平\n3. 滤篮底部的平整度：确保无变形\n\n压力分布对风味的影响：\n- 均匀压力分布：萃取均衡，风味层次丰富，酸甜苦平衡\n- 不均匀压力分布：导致渠道流(channeling)，咖啡会同时存在过度萃取（苦、涩）和萃取不足（酸、淡）的特征，风味不协调\n\n改善压力分布的方法包括使用VST精密滤篮、58.5mm校准压粉器和WDT分布技术。"
  },
  {
    "instruction": "如果我想冲煮一杯酸度明亮的手冲咖啡，应该如何选择咖啡豆和控制冲煮参数？",
    "input": "",
    "output": "要冲煮一杯酸度明亮的手冲咖啡，可从以下几个方面着手：\n\n【咖啡豆选择】\n1. 产区：优先选择高海拔非洲产区咖啡，如埃塞俄比亚耶加雪菲、肯尼亚AA、卢旺达等\n2. 处理法：选择水洗处理的咖啡豆，能保留更清晰的酸度\n3. 烘焙度：选择浅度烘焙的咖啡豆，可保留更多原始酸度\n4. 新鲜度：使用烘焙后7-21天内的咖啡豆，太新会有过强的烘焙气体\n\n【冲煮参数控制】\n1. 研磨度：稍细于中等研磨度，但避免过细导致苦味\n2. 水温：90-92°C，略低于标准温度(94°C)可减少苦味提取\n3. 粉水比：1:16至1:17，相对标准比例略淡\n4. 萃取时间：总时间控制在2分30秒左右\n5. 注水技巧：\n   - 布隆时间延长至45秒\n   - 第一次注水后快速注入剩余水量\n   - 采用高注水点，增加水流对咖啡粉的冲击力\n\n【其他建议】\n使用材质为陶瓷或玻璃的滤杯，有助于保持更稳定的温度。滤纸选择白色未漂白滤纸，预先用热水冲洗去除纸味。"
  },
  {
    "instruction": "分析这段杯测描述并生成风味雷达图数据：\"这款咖啡带有明显的柑橘酸，入口有柠檬皮的明亮感，中段出现蓝莓和黑醋栗的风味，余韵中带有焦糖和杏仁的甜感，酒体中等偏轻，整体平衡度好。\"",
    "input": "",
    "output": "基于杯测描述，风味雷达图数据分析如下：\n\n酸度: 8.5/10 (明显的柑橘酸，柠檬皮的明亮感)\n甜度: 7/10 (焦糖和杏仁的甜感)\n苦度: 4/10 (描述中未强调苦味特征)\n酒体: 5.5/10 (中等偏轻)\n平衡度: 8/10 (整体平衡度好)\n\n风味类别分布：\n- 水果类: 8/10 (柑橘、柠檬皮、蓝莓、黑醋栗)\n- 坚果类: 6/10 (杏仁)\n- 焦糖类: 6.5/10 (焦糖)\n- 花香类: 3/10 (隐含特征，未明确提及)\n- 香料类: 2/10 (未明确提及)\n\n主要风味标记：\n- 柑橘\n- 柠檬皮\n- 蓝莓\n- 黑醋栗\n- 焦糖\n- 杏仁\n\n根据分析，这款咖啡可能是中浅烘焙的高海拔咖啡，可能来自非洲产区(如埃塞俄比亚或肯尼亚)或中美洲产区(如哥斯达黎加或巴拿马)。"
  }
]
    </div>
    
    <h2>3. 微调策略</h2>
    
    <h3>3.1 微调方法选择</h3>
    <p>采用多阶段微调策略：</p>
    <ol>
        <li><strong>第一阶段</strong>：持续预训练(Continued Pre-training)
            <ul>
                <li>使用大量咖啡领域文本进行无监督学习</li>
                <li>帮助模型熟悉咖啡领域术语和概念</li>
            </ul>
        </li>
        <li><strong>第二阶段</strong>：监督微调(Supervised Fine-tuning)
            <ul>
                <li>使用高质量问答对进行监督学习</li>
                <li>提升模型对咖啡问题的回答质量</li>
            </ul>
        </li>
        <li><strong>第三阶段</strong>：参数高效微调(PEFT)
            <ul>
                <li>使用LoRA技术对特定任务进行优化</li>
                <li>针对萃取计算、风味分析、设备诊断单独训练</li>
            </ul>
        </li>
    </ol>
    
    <h3>3.2 微调超参数</h3>
    <table>
        <tr>
            <th>阶段</th>
            <th>学习率</th>
            <th>批次大小</th>
            <th>训练轮次</th>
            <th>优化器</th>
        </tr>
        <tr>
            <td>持续预训练</td>
            <td>5e-6</td>
            <td>32</td>
            <td>3</td>
            <td>AdamW</td>
        </tr>
        <tr>
            <td>监督微调</td>
            <td>1e-5</td>
            <td>16</td>
            <td>5</td>
            <td>AdamW</td>
        </tr>
        <tr>
            <td>LoRA微调(萃取计算)</td>
            <td>2e-4</td>
            <td>8</td>
            <td>10</td>
            <td>AdamW</td>
        </tr>
        <tr>
            <td>LoRA微调(风味分析)</td>
            <td>2e-4</td>
            <td>8</td>
            <td>8</td>
            <td>AdamW</td>
        </tr>
        <tr>
            <td>LoRA微调(设备诊断)</td>
            <td>2e-4</td>
            <td>8</td>
            <td>12</td>
            <td>AdamW</td>
        </tr>
    </table>
    
    <h3>3.3 LoRA配置</h3>
    <p>针对不同任务的LoRA配置：</p>
    <div class="code-block">
{
  "extraction_calculator": {
    "r": 16,           // LoRA的秩
    "alpha": 32,       // LoRA的缩放参数
    "dropout": 0.05,   // Dropout率
    "target_modules": ["q_proj", "k_proj", "v_proj", "o_proj"],  // 目标层
    "bias": "none"     // 是否包含偏置项
  },
  "flavor_analyzer": {
    "r": 8,
    "alpha": 16,
    "dropout": 0.1,
    "target_modules": ["q_proj", "v_proj"],
    "bias": "none"
  },
  "equipment_diagnosis": {
    "r": 24,
    "alpha": 48,
    "dropout": 0.05,
    "target_modules": ["q_proj", "k_proj", "v_proj", "o_proj", "gate_proj", "up_proj", "down_proj"],
    "bias": "none"
  }
}
    </div>
    
    <h2>4. 评估方法</h2>
    
    <h3>4.1 评估指标</h3>
    <table>
        <tr>
            <th>评估维度</th>
            <th>评估指标</th>
            <th>目标值</th>
        </tr>
        <tr>
            <td>知识准确性</td>
            <td>专家评分(1-5分)</td>
            <td>≥4.5</td>
        </tr>
        <tr>
            <td>回答完整性</td>
            <td>信息覆盖率(%)</td>
            <td>≥90%</td>
        </tr>
        <tr>
            <td>专业术语使用</td>
            <td>术语精确度(%)</td>
            <td>≥95%</td>
        </tr>
        <tr>
            <td>计算准确性</td>
            <td>萃取参数计算误差(%)</td>
            <td>≤2%</td>
        </tr>
        <tr>
            <td>风味分析准确性</td>
            <td>与专业杯测师一致性(%)</td>
            <td>≥85%</td>
        </tr>
        <tr>
            <td>诊断准确率</td>
            <td>问题诊断准确率(%)</td>
            <td>≥80%</td>
        </tr>
    </table>
    
    <h3>4.2 评估数据集</h3>
    <p>构建专门的咖啡领域测试集：</p>
    <ul>
        <li><strong>知识测试集</strong>：500个咖啡专业知识问题，由国际咖啡品鉴师协会认证的Q-Grader和SCA认证讲师提供标准答案</li>
        <li><strong>萃取计算测试集</strong>：200个萃取参数计算案例，包含不同烘焙度、设备和目标风味的计算任务</li>
        <li><strong>风味分析测试集</strong>：150个杯测描述，由多位专业杯测师共同标注的风味特征作为标准</li>
        <li><strong>设备诊断测试集</strong>：180个设备问题案例，由专业维修技师确认的诊断结果作为标准</li>
    </ul>
    
    <h3>4.3 人工评估</h3>
    <p>除了自动评估外，引入人工评估环节：</p>
    <ul>
        <li>咖啡专业人士盲测评估：5位咖啡专业人士对模型回答进行盲测评分</li>
        <li>用户满意度测试：邀请50位不同咖啡经验水平的用户测试系统并评分</li>
        <li>A/B测试：将微调前后的模型回答进行对比，评估改进效果</li>
    </ul>
    
    <h2>5. 部署与更新策略</h2>
    
    <h3>5.1 模型合并策略</h3>
    <p>基于用户场景动态加载不同微调模型：</p>
    <ul>
        <li>基础模型：通过持续预训练和监督微调的通用咖啡知识模型</li>
        <li>专用模型：根据用户交互场景动态加载对应的LoRA权重</li>
    </ul>
    
    <div class="code-block">
def load_coffee_model(user_scenario=None):
    # 加载基础模型
    base_model = load_model("coffee_base_model")
    
    # 根据用户当前场景动态加载LoRA权重
    if user_scenario == "extraction_calculator":
        lora_weights = load_lora_weights("extraction_calculator_lora")
        return apply_lora_weights(base_model, lora_weights)
    elif user_scenario == "flavor_analysis":
        lora_weights = load_lora_weights("flavor_analyzer_lora")
        return apply_lora_weights(base_model, lora_weights)
    elif user_scenario == "equipment_diagnosis":
        lora_weights = load_lora_weights("equipment_diagnosis_lora")
        return apply_lora_weights(base_model, lora_weights)
    else:
        # 默认使用基础模型
        return base_model
    </div>
    
    <h3>5.2 持续优化计划</h3>
    <p>建立循环改进机制：</p>
    <ol>
        <li><strong>用户反馈收集</strong>：记录用户对模型回答的评价和修正</li>
        <li><strong>错误分析</strong>：定期分析模型常见错误和不足</li>
        <li><strong>数据增强</strong>：针对薄弱领域补充训练数据</li>
        <li><strong>定期再训练</strong>：每季度使用更新的数据集进行再训练</li>
        <li><strong>A/B测试</strong>：新模型上线前进行对比测试验证效果</li>
    </ol>
    
    <div class="warning">
        <p><strong>注意事项：</strong></p>
        <p>1. 定期评估模型是否出现领域外知识退化现象</p>
        <p>2. 监控模型在不同用户群体中的表现差异</p>
        <p>3. 确保新收集的数据经过专业人士审核，避免引入错误知识</p>
    </div>
</body>
</html>